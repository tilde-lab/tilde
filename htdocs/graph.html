<!-- SVG graph renderer
based on d3.js
v281213 -->
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
*{font-family:"Courier New";margin:0;padding:0;}
.edge{
    fill:none;
    stroke:#ccc;
    stroke-width:1px;
}
.edge.influences{
    stroke:#06c;
}
circle{
    fill:#fff;
    stroke:#ccc;
    stroke-width:1px;
    cursor:pointer;
}
text{
    font-size:14px;
    font-weight:bold;
    cursor:pointer;
    text-shadow:0 2px 0 #fff, 2px 0 0 #fff, 0 -2px 0 #fff, -2px 0 0 #fff;
    fill:#000;
}
text.shadow{
    stroke:#fff;
    stroke-width:3px;
    stroke-opacity:0.8;
}
/* marker#belongs{fill:#ccc;} */
marker#influences{fill:#06c;}
</style>

<script type="text/javascript" src="/static/d3.v3.min.js"></script>
</head>
<body></body>

<script type="text/javascript">
var build_graph;
var standalone = !("_tilde" in window.parent) || !("graph_comm" in window.parent._tilde);

(build_graph = function(){
    var source=[];
    var edges=[], nodes={};
    var actson={}, actedby={};
    
    if (standalone){
        source = [{'source': 'primary', 'target': 'secondary', 'type': 'belongs' }, {'source': 'primary', 'target': 'ternary', 'type': 'influences' }, {'source': 'secondary', 'target': 'ternary', 'type': 'actson' },{'source': 'ternary', 'target': 'secondary', 'type': 'actedby' }];
    } else {    
        source = JSON.parse(window.parent._tilde.graph_comm);
    }
    
    var ref;        
    if (standalone) ref = document;
    else ref = window.parent.document;
    
    // Legend   
    if (!window.has_mmreasoner_legend){
        var legend_html = 'Legend:<div style="float:right;width:16px;height:16px;cursor:pointer;background:url(/static/images/cancel.gif) no-repeat;" id="_close_"></div><div id="graph_legend_inferred" style="display:none;" class="graph_legends"><div style="color:#0c3;">node acts on<div style="float:right;width:16px;height:16px;background:#0c3;-webkit-border-radius:8px;-moz-border-radius:8px;border-radius:8px;"></div></div><div style="color:#f00;">node is acted by<div style="float:right;width:16px;height:16px;background:#f00;-webkit-border-radius:8px;-moz-border-radius:8px;border-radius:8px;"></div></div></div><div id="graph_legend_none" style="display:none;" class="graph_legends">no conclusions made</div><div id="graph_legend_init" style="display:none;" class="graph_legends">touch or drag any node to start</div>';
        var legend_css = 'position:fixed;z-index:99999;bottom:4px;left:4px;padding:10px;width:350px;height:100px;-webkit-border-radius:8px;-moz-border-radius:8px;border-radius:8px;background:#ffc;line-height:1.4em;font-size:1.15em;font-weight:bold;';
        var graph_legend = ref.createElement( 'div' );
        graph_legend.innerHTML = legend_html;
        graph_legend.style.cssText = legend_css;
        graph_legend.setAttribute('id', 'mmreasoner_legend');
        ref.getElementsByTagName('body')[0].appendChild( graph_legend );
        
        var cr = ref.getElementById('_close_');
        cr.onclick = function(e){
            var ml = ref.getElementById('mmreasoner_legend');
            ml.parentNode.removeChild(ml);
            window.has_mmreasoner_legend = false;
        };       
        window.has_mmreasoner_legend = true;
    }  
    var l_a = ref.getElementsByClassName('graph_legends'),
    l_1 = ref.getElementById('graph_legend_inferred'),
    l_2 = ref.getElementById('graph_legend_none'),
    l_3 = ref.getElementById('graph_legend_init');
    
    // Filter edges and compute the distinct nodes from the links
    source.forEach(function(link){
        if (link.type == 'actson'){
            (link.source in actson) ? (actson[link.source].push(link.target)) : actson[link.source] = [link.target];
        } else if (link.type == 'actedby') {
            (link.source in actedby) ? (actedby[link.source].push(link.target)) : actedby[link.source] = [link.target];
        } else {
            link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
            link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
            edges.push(link);
        }
    });
            
    var table = {};
    var i=0;
    for (var p in nodes){
        table[p] = i++;
    }

    var width = document.body.clientWidth-50, height = 1900;
    
    d3.select("svg").remove();
    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);
        
    // Per-type markers
    svg.append("defs").selectAll("marker")
        .data(["influences"])
        .enter().append("marker")
        .attr("id", function(d){return d})
        .attr("viewBox", "0 0 40 20")
        .attr("refX", 55)
        .attr("refY", 10)
        .attr("markerWidth", 16)
        .attr("markerHeight", 12)
        .attr("orient", "auto")
        .append("polyline")
        .attr("points", "0,0 40,10 0,20 10,10");

    var force = d3.layout.force()
        .nodes(d3.values(nodes))
        .links(edges)
        .size([width, height*=2/3])
        .linkDistance(150)
        .gravity(0.1)
        .charge(-1500)
        .on("tick", tick)
        .start();
        
    var path = svg.append("g").selectAll("path")
        .data(force.links())
        .enter().append("path")
        .attr("class", function(d) { return "edge " + d.type; })
        .attr("marker-end", function(d) { return "url(#" + d.type + ")"; });
        
    var link = svg.selectAll(".edge");

    var circle = svg.append("g").selectAll("circle")
        .data(force.nodes())
        .enter().append("circle")
        .attr("r", 8)
        .attr("id", function(d,i) { return "c_"+table[d.name] })
        .call(force.drag);

    var text = svg.append("g").selectAll("g")
        .data(force.nodes())
        .enter().append("g");

    // A copy of the text with a thick white stroke for legibility
    text.append("text")
        .attr("x", 12)
        .attr("y", ".31em")
        .attr("class", "shadow")
        .attr("id", function(d,i) { return "s_"+table[d.name] })
        .text(function(d) { return d.name; });

    text.append("text")
        .attr("x", 12)
        .attr("y", ".31em")
        .attr("id", function(d,i) { return "t_"+table[d.name] })
        .text(function(d) { return d.name; });
        
    circle.on("mouseover", function(d) { handle(d) });
    text.on("mouseover", function(d) { handle(d) });
    circle.on("mouseout", function(d) { dehandle(d) });
    text.on("mouseout", function(d) { dehandle(d) });

    function tick() {        
      path.attr("d", direct);
      circle.attr("transform", transform);
      text.attr("transform", transform);
    }

    function direct(d) {
      return "M" + d.source.x + "," + d.source.y + " " + d.target.x + "," + d.target.y;
    }

    function transform(d) {
      return "translate(" + d.x + "," + d.y + ")";
    }
    
    function handle(x){
        var showflag;
        if (x.name in actson){
            actson[x.name].forEach(function(v){
                d3.select('#c_' + table[v]).style("fill", "#0c3");
                d3.select('#t_' + table[v]).style("fill", "#0c3");
            });
            showflag=1
        }
        if (x.name in actedby){
            actedby[x.name].forEach(function(v){
                d3.select('#c_' + table[v]).style("fill", "#f00");
                d3.select('#t_' + table[v]).style("fill", "#f00");
            });
            showflag=1
        }
        
        Array.prototype.forEach.call(l_a, function(i){ i.style.display = "none" });
        if (showflag){
            l_1.style.display = "block";
        } else {
            l_2.style.display = "block"; 
        }
    }
    
    function dehandle(x){
        d3.selectAll('text').style("fill", "#000");
        d3.selectAll('circle').style("fill", "#fff");
        Array.prototype.forEach.call(l_a, function(i){ i.style.display = "none" });
        l_3.style.display = "block";
    }  
    
    // Speed up simulation convergence
    var s=0;
    while(force.alpha() > 0.01) {
        force.tick();
        if(s++ > 500) break;
    }
    
    Array.prototype.forEach.call(l_a, function(i){ i.style.display = "none" });
    l_3.style.display = "block";
})();
</script>
</html>
